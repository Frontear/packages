#!/bin/sh

pushd $(dirname $0) >> /dev/null

# Remake database for packages
if [ -d ../x86_64 ]; then
    rm -rf ../x86_64
fi

if [ ! -d ../x86_64 ];then
    mkdir ../x86_64
fi

DEPS_COUNT=0
PKGS_COUNT=$(ls -A ../src | wc -l)
PKGS_BUILT=()

while [ ${#PKGS_BUILT[@]} -lt $PKGS_COUNT ]; do
    for SRC in ../src/*; do
        if [ $(ls -A $SRC/deps | wc -l) -eq $DEPS_COUNT ]; then
            DEPENDS=()

            if [ $DEPS_COUNT -gt 0 ]; then
                for DEP in $SRC/deps/*; do
                    PKG=$(find $(readlink -f $DEP) -name "*.pkg.tar.zst")

                    if [ ! -z "$PKG" ]; then
                        DEPENDS+=("-I $PKG")
                    fi
                done
            fi
            
            pushd $SRC > /dev/null
            
            makepkg_chroot "${DEPENDS[@]}"
            PKGS_BUILT+=("$(find $PWD -name "*.pkg.tar.zst")")
            
            popd > /dev/null
        fi
    done

    DEPS_COUNT=$((DEPS_COUNT + 1))
done

for PKG in "${PKGS_BUILT[@]}"; do
    mv $PKG ../x86_64/
done

popd >> /dev/null
